# Request Body

## ESPF Event Data

The [ESPF event][espf-event] generated by [EventSender][eventsender] contains a limited set of [variables][variables] (`event_type`, `i_account`, `i_env`, etc.), but external systems usually require more information (about the main product, add-ons, used quotas, etc.).

??? example "Example of NSPF event"

    ```json
        {
            "event_type":"SIM/Updated",
            "variables":{
              "i_env":3,
              "i_event":999999,
              "i_account":277147,
              "event_time":"2025-05-01 12:00:00"
            }
        }
    ```

Therefore, the [NSPS system][nsps] makes API requests api-requests to PortaBilling in order to get more information about the account, SIM, etc., which relates to the created event. The NSPS adds all the necessary [data][enriched-event] and passes it to the connector.

NSPS sends the following request body to the connector (so the connector should accept it):

| Field Name   | Mandatory | Description                                                                                     |
| ------------ | --------- | ----------------------------------------------------------------------------------------------- |
| `pb_data`    | No        | Enriched data from PortaBilling; includes account, SIM, and access policy info. Defaults empty. |
| `data`       | Yes       | Event payload, represented by an instance of `ESPFEvent`.                                       |
| `handler_id` | No        | Optional identifier of the handler assigned to process the event.                               |
| `status`     | No        | Status of event processing. Defaults to `EventStatus.UNDEFINED`.                                |
| `created_at` | No        | Timestamp when the event was created.                                                           |
| `updated_at` | No        | Timestamp when the event was last enriched by NSPS.                                             |
| `event_id`   | Yes       | Unique identifier of the event.                                                                 |

The field called `data` contains the generated ESPF event as it is. So if you don't need additional info from PortaBilling, you can only use this data.

The data structure for the [`PortaBillingData`][portabilling-data] (`pb_data`) is shown below. It includes all possible fields. The connector should contain logic to process only the parameters it needs, and unnecessary ones can be ignored.

For a more detailed description of the parameters, please refer to [docs.portaone.com][more-detaile-api].

## PortaBilling Data

_Type_: `PortaBillingData`

This section contains enriched data received from PortaBilling.
It provides detailed information about the account, SIM card, products, features, policies, and usage counters associated with the subscriber.

| Field Path             | Type                                               | Description                                                   |
| ---------------------- | -------------------------------------------------- | ------------------------------------------------------------- |
| `account_info`         | [`AccountInfo`][account-info]                      | Main account-level data container.                            |
| `sim_info`             | [`SimInfo`][sim-info]                              | SIM card information from PortaBilling.                       |
| `prev_sim_info`        | [`SimInfo`][sim-info]                              | Previous SIM card information (used for SIM/Replaced events). |
| `access_policy_info`   | `List[`[`AccessPolicyInfo`][access-policy-info]`]` | Access policy information from PortaBilling.                  |
| `product_info`         | [`ProductInfo`][product-info]                      | Product information from PortaBilling.                        |
| `full_vd_counter_info` | `List[`[`VDCounterInfo`][vd-counter-info]`]`       | VD counter information from PortaBilling.                     |

### Account Info

_Type_: `AccountInfo`

_Relation_: `account_info`: `AccountInfo` in [`PortaBillingData`][portabilling-data] (`pb_data`)

The main account-level data container.
It provides billing information, account status, assigned product, customer relations, and owner’s contact details.

<div class="annotate" markdown>

| Field Path         | Type                                         | Description                                                                                                    |
| ------------------ | -------------------------------------------- | -------------------------------------------------------------------------------------------------------------- |
| `bill_status`      | `str`                                        | The billing status of the account. (1)                                                                         |
| `billing_model`    | `str`                                        | The account type. (2)                                                                                          |
| `blocked`          | `bool`                                       | Boolean conversion - Indicates whether account's calls and access to the self-care interface is blocked. (3)   |
| `email`            | `str`                                        | The email address associated with the account.                                                                 |
| `firstname`        | `str`                                        | The account owner's first name.                                                                                |
| `i_account`        | `int`                                        | Internal ID of the account. Visible in URL resource path on Admin UI page.                                     |
| `i_customer`       | `int`                                        | The ID of the customer record to which the account belongs.                                                    |
| `i_master_account` | `int`                                        | The ID of the parent account.                                                                                  |
| `i_product`        | `int`                                        | The ID for the account's product.                                                                              |
| `i_vd_plan`        | `int`                                        | The unique ID of the bundle assigned to the account individually.                                              |
| `id`               | `str`                                        | Charging ID (MSISDN, ICCID or IMSI) of the account on the network. Visible as ID in Admin UI.                  |
| `lastname`         | `str`                                        | The account owner's last name.                                                                                 |
| `phone1`           | `str`                                        | The main phone number.                                                                                         |
| `product_name`     | `str`                                        | The name of the account's product.                                                                             |
| `status`           | `str`                                        | The current status of the account based on factors such as "expiration time", "activation time" and so on. (4) |
| `time_zone_name`   | `str`                                        | The name of the account's time zone. (5)                                                                       |
| `zip`              | `str`                                        | The postal (zip) code.                                                                                         |
| `assigned_addons`  | `List[`[`AssignedAddon`][assigned-add-on]`]` | List of account's add-on products.                                                                             |
| `service_features` | `List[`[`AssignedAddon`][service-feature]`]` | List of service features.                                                                                      |

</div>

1.  Mapped values (originally single-letter codes):
    - `O` → active
    - `S` → suspended
    - `I` → inactive
    - `C` → terminated
2.  Mapped values (originally int codes):
    - -1 → debit_account
    - 0 → recharge_voucher
    - 1 → credit_account
    - 2 → alias
    - 4 → beneficiary
3.  originally `Y/N` `string`, converted `Y` → `False`, `N` → `True`
4.  Possible values:
    - `active`
    - `customer_exported`
    - `expired`
    - `quarantine`
    - `screening`
    - `closed`
    - `inactive`
    - `customer_suspended`
    - `customer_limited`
    - `customer_provisionally_terminated`
    - `blocked`
    - `customer_blocked`
    - `not_yet_active`
    - `credit_exceeded`
    - `overdraft`
    - `customer_has_no_available_funds`
    - `customer_credit_exceed`
    - `zero_balance`
    - `customer_suspension_delayed`
    - `customer_limiting_delayed`
    - `frozen`
5.  Examples: "Europe/Prague", "America/Vancouver", etc.

??? example "Example: `AccountInfo`"

    ```json linenums="1"
    {
        "bill_status": "open",
        "billing_model": "credit_account",
        "blocked": false,
        "i_account": 1,
        "i_customer": 6392,
        "i_product": 3774,
        "id": "79123456789@msisdn",
        "phone1": "",
        "product_name": "wtl Pay as you go",
        "time_zone_name": "Europe/Prague",
        "assigned_addons": [
            {
                "addon_effective_from": "2025-05-16T12:59:46",
                "addon_priority": 10,
                "description": "",
                "i_product": 3775,
                "i_vd_plan": 1591,
                "name": "wtl Youtube UHD"
            }
        ],
        "service_features": [
            {
                "name": "netaccess_policy",
                "effective_flag_value": "Y",
                "attributes": [
                    {
                        "name": "access_policy",
                        "effective_value": "179"
                    }
                ]
            }
        ]
    }
    ```

#### Assigned Add-on

_Type_: `AssignedAddon`

_Relation_: `assigned_addons`: `List[AssignedAddon]` in [`AccountInfo`][account-info] (`account_info`)

The list of the account's add-on products

<div class="annotate" markdown>

| Field Path             | Type  | Description                                                                                         |
| ---------------------- | ----- | --------------------------------------------------------------------------------------------------- |
| `addon_effective_from` | `str` | ISO datetime string - The date and time when the add-on product is activated for an account. (1)    |
| `addon_effective_to`   | `str` | ISO datetime string - The date and time when the add-on product assigned to an account expires. (2) |
| `addon_priority`       | `int` | The priority level of the add-on product.                                                           |
| `description`          | `str` | The internal product description.                                                                   |
| `i_product`            | `int` | The unique ID of the product.                                                                       |
| `i_product_group`      | `int` | The unique ID of the product group to which the product belongs.                                    |
| `i_vd_plan`            | `int` | The unique ID of the bundle assigned to the product.                                                |
| `name`                 | `str` | The product name.                                                                                   |

</div>

1. Originally `Optional[str]` datetime
2. Originally `Optional[str]` datetime

??? example "Example: `AssignedAddon`"

    ```json
        {
            "addon_effective_from": "2025-05-16T12:59:46",
            "addon_priority": 10,
            "description": "",
            "i_product": 3775,
            "i_vd_plan": 1591,
            "name": "wtl Youtube UHD"
        }
    ```

#### Service Feature

_Type_: `ServiceFeature`

_Relation_: `service_features`: `List[ServiceFeature]` in [`AccountInfo`][account-info] (`account_info`)

List of service features assigned to the account, each with its attributes.

<div class="annotate" markdown>

| Field Path                     | Type                            | Description                                                          |
| ------------------------------ | ------------------------------- | -------------------------------------------------------------------- |
| `name`                         | `str`                           | The service feature name.                                            |
| `effective_flag_value`         | `str`                           | The actual service feature flag value. (1)                           |
| `attributes`                   | `List[ServiceFeatureAttribute]` | The list of service feature attributes.                              |
| `attributes[].name`            | `str`                           | The service feature attribute internal name.                         |
| `attributes[].effective_value` | `str`                           | Service feature attribute value, comma-separated if multiple values. |

</div>

1. Possible values:
    - `Y` → enabled
    - `N` → disabled

??? example "Example: `ServiceFeature`"

    ```json
        {
            "name": "netaccess_policy",
            "effective_flag_value": "Y",
            "attributes": [
                {
                    "name": "access_policy",
                    "effective_value": "179"
                }
            ]
        }
    ```

### SIM Info

_Type_: `SimInfo`

_Relation_:

- `sim_info`: `SimInfo` in [`PortaBillingData`][portabilling-data] (`pb_data`)
- `prev_sim_info`: `SimInfo` in [`PortaBillingData`][portabilling-data] (`pb_data`)

SIM card information from PortaBilling

<div class="annotate" markdown>

| Field Path   | Type  | Description                                                          |
| ------------ | ----- | -------------------------------------------------------------------- |
| `i_account`  | `int` | The unique ID of the account to which the SIM card belongs.          |
| `i_sim_card` | `int` | The unique ID of the SIM card.                                       |
| `iccid`      | `str` | The Integrated Circuit Card ID.                                      |
| `imsi`       | `str` | The unique International Mobile Subscriber Identity of the SIM card. |
| `msisdn`     | `str` | The Mobile Subscriber Integrated Services Digital Number.            |
| `status`     | `str` | The status of the SIM card. (1)                                      |

</div>

1. Possible values:
    - `available` → the SIM card is available for assignment,
    - `reserved` → reserved for the customer, but not yet assigned to the account,
    - `used` → SIM card is being used by the account,
    - `disposed` → SIM card is disposed and cannot be used.

??? example "Example: `SimInfo`"

    ```json
        {
            "i_sim_card": 3793,
            "imsi": "001010000020349",
            "msisdn": "79123456789",
            "status": "active"
        }
    ```

### Access Policy Info

_Type_: `AccessPolicyInfo`

_Relation_: `access_policy_info`: `AccessPolicyInfo` in [`PortaBillingData`][portabilling-data] (`pb_data`)

Information about access policies applied to the account.

| Field Path                | Type                          | Description                                                         |
| ------------------------- | ----------------------------- | ------------------------------------------------------------------- |
| `i_access_policy`         | `int`                         | The unique ID of the Access Policy.                                 |
| `name`                    | `str`                         | The name of the Access Policy.                                      |
| `attributes`              | `List[AccessPolicyAttribute]` | The list of related service policy attribute values.                |
| `attributes[].group_name` | `str`                         | The name used to group service policy attributes.                   |
| `attributes[].name`       | `str`                         | The name of the service policy attribute.                           |
| `attributes[].value`      | `str`                         | Service policy attribute value, comma-separated if multiple values. |

??? example "Example: `AccessPolicyInfo`"

    ```json
        {
            "i_access_policy":179,
            "name":"WTL integration test",
            "attributes":[
                {
                    "group_name":"lte.wtl",
                    "name":"cs_profile",
                    "value":"cs-pp-20250319"
                },
                {
                    "group_name":"lte.wtl",
                    "name":"eps_profile",
                    "value":"eps-pp-20250319"
                }
            ]
        }
    ```

### Product Info

_Type_: `ProductInfo`

_Relation_: `product_info`: `ProductInfo` in [`PortaBillingData`][portabilling-data] (`pb_data`)

Product information from PortaBilling

<div class="annotate" markdown>

| Field Path       | Type  | Description                                                                        |
| ---------------- | ----- | ---------------------------------------------------------------------------------- |
| `name`           | `str` | The product name.                                                                  |
| `description`    | `str` | The internal product description.                                                  |
| `i_product`      | `int` | The unique ID of the product.                                                      |
| `i_vd_plan`      | `int` | The unique ID of the bundle assigned to the product. <!-- Тут можливо помилка! --> |
| `addon_priority` | `int` | The priority level of the add-on product. (1)                                      |

</div>

1.  - 0 → main product
    - 10 → low
    - 15 → medium low
    - 20 → medium
    - 25 → medium high
    - 30 → high

??? example "Example: `ProductInfo`"

      ```json
          {
              "name":"DEV WTL Pay as you go",
              "description":"",
              "addon_priority":0,
              "i_product":658
          }
      ```

### VD Counter Info

_Type_: `VDCounterInfo`

_Relation_: `full_vd_counter_info`: `List[VDCounterInfo]` in [`PortaBillingData`][portabilling-data] (`pb_data`)

VD counter information from PortaBilling

<div class="annotate" markdown>

| Field Path         | Type        | Description                                                                                       |
| ------------------ | ----------- | ------------------------------------------------------------------------------------------------- |
| `discount_info`    | `str`       | Short representation of the discount details (e.g., '0..60 - 100%').                              |
| `dg_name`          | `str`       | The name of the destination group the bundle item is applied to.                                  |
| `i_vd_plan`        | `int`       | The unique ID of the bundle.                                                                      |
| `i_dest_group`     | `int`       | The unique ID of the destination group the discount is applied to.                                |
| `allocated_amount` | `float`     | The total amount of service volume allocated to the customer/account in the current usage period. |
| `unit`             | `str`       | The name of the service unit or currency used.                                                    |
| `addon_priority`   | `int`       | The priority level of the bundle item. (1)                                                        |
| `vdp_name`         | `str`       | The name of the bundle.                                                                           |
| `i_vd_dg`          | `int`       | The unique ID of the bundle item.                                                                 |
| `i_service`        | `int`       | The unique ID of the service.                                                                     |
| `service_name`     | `str`       | The name of the service the discount is applied to.                                               |
| `remaining`        | `float/str` | The service volume that remains to be used to reach the current threshold. (2)                    |

</div>

1. Possible values:
    - -1 → no priority
    - 0 → main product
    - 10 → low
    - 12 → bundled credit wallets
    - 13 → bundled credits
    - 14 → bundled credit preferred wallets
    - 15 → medium low
    - 20 → medium
    - 25 → medium high
    - 30 → high
    - 255 → not part of a product
2. Can be numeric value or string like `N/A`

??? example "Example: `VDCounterInfo`"

    ```json
        {
            "service_name":"Internet Access KB",
            "vdp_name":"DEV WTL Free 10MB (1 day)",
            "i_vd_plan":204,
            "i_dest_group":2650,
            "addon_priority":10,
            "i_vd_dg":283,
            "remaining":"10",
            "i_service":106,
            "dg_name":"RG100",
            "discount_info":"0..10 - 100%",
            "unit":"megabyte",
            "allocated_amount":10
        }
    ```

<!-- References -->

[espf-event]: https://docs.portaone.com/docs/mr121-events-that-espf-handlers-support?topic=eventsender-handler-events
[eventsender]: https://docs.portaone.com/docs/mr121-provisioning-via-webhooks?topic=provisioning-event-version
[variables]: https://docs.portaone.com/docs/mr121-provisioning-via-webhooks?topic=provisioning-event-version
[more-detaile-api]: https://docs.portaone.com/API/mr120/AccountInterface/#overview
[nsps]: ../../NSPS/nsps-overview.md
[enriched-event]: ../../NSPS/data-flows.md#output
[portabilling-data]: #portabilling-data
[account-info]: #account-info
[assigned-add-on]: #assigned-add-on
[service-feature]: #service-feature
[sim-info]: #sim-info
[previous-sim-info]: #previous-sim-info
[access-policy-info]: #access-policy-info
[product-info]: #product-info
[vd-counter-info]: #vd-counter-info
